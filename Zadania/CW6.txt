SET SERVEROUTPUT ON;

CREATE OR REPLACE PROCEDURE add_job (
  p_job_id    IN jobs.job_id%TYPE,
  p_job_title IN jobs.job_title%TYPE
) AS
BEGIN
  INSERT INTO jobs (job_id, job_title, min_salary, max_salary)
  VALUES (p_job_id, p_job_title, 0, 0);

  DBMS_OUTPUT.PUT_LINE('Dodano JOB_ID = ' || p_job_id);

EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('Błąd podczas dodawania pracy: ' || SQLERRM);
END;
/
-- TEST
-- EXEC add_job(9001, 'TEST_JOB');



CREATE OR REPLACE PROCEDURE update_job_title (
  p_job_id     IN jobs.job_id%TYPE,
  p_new_title  IN jobs.job_title%TYPE
) AS
  e_no_update EXCEPTION;
  PRAGMA EXCEPTION_INIT(e_no_update, -20001);
BEGIN
  UPDATE jobs
  SET    job_title = p_new_title
  WHERE  job_id = p_job_id;

  IF SQL%ROWCOUNT = 0 THEN
    RAISE_APPLICATION_ERROR(-20001, 'Nie zaktualizowano żadnego JOB — nie istnieje ID!');
  END IF;

  DBMS_OUTPUT.PUT_LINE('Zaktualizowano JOB_ID = ' || p_job_id);

EXCEPTION
  WHEN e_no_update THEN
    DBMS_OUTPUT.PUT_LINE('Błąd: ' || SQLERRM);
END;
/
-- TEST
-- EXEC update_job_title(9001, 'NEW_JOB_TITLE');


CREATE OR REPLACE PROCEDURE delete_job (
  p_job_id IN jobs.job_id%TYPE
) AS
BEGIN
  DELETE FROM jobs WHERE job_id = p_job_id;

  IF SQL%ROWCOUNT = 0 THEN
    RAISE_APPLICATION_ERROR(-20002, 'Nie usunięto żadnego JOB — nie istnieje ID!');
  END IF;

  DBMS_OUTPUT.PUT_LINE('Usunięto JOB_ID = ' || p_job_id);

EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('Błąd usuwania: ' || SQLERRM);
END;
/
-- TEST
-- EXEC delete_job(9001);


CREATE OR REPLACE PROCEDURE get_emp_salary_name (
  p_emp_id   IN  employees.employee_id%TYPE,
  p_lastname OUT employees.last_name%TYPE,
  p_salary   OUT employees.salary%TYPE
) AS
BEGIN
  SELECT last_name, salary
  INTO   p_lastname, p_salary
  FROM   employees
  WHERE  employee_id = p_emp_id;

EXCEPTION
  WHEN NO_DATA_FOUND THEN
    DBMS_OUTPUT.PUT_LINE('Pracownik nie istnieje!');
END;
/
-- TEST
-- DECLARE l_last employees.last_name%TYPE; l_sal NUMBER;
-- BEGIN get_emp_salary_name(100, l_last, l_sal); DBMS_OUTPUT.PUT_LINE(l_last||' '||l_sal); END;
/

CREATE SEQUENCE emp_seq START WITH 3000 INCREMENT BY 1;

CREATE OR REPLACE PROCEDURE add_employee (
  p_last_name  IN employees.last_name%TYPE,
  p_first_name IN employees.first_name%TYPE,
  p_salary     IN employees.salary%TYPE,
  p_job_id     IN employees.job_id%TYPE DEFAULT 1,
  p_dept_id    IN employees.department_id%TYPE DEFAULT 10
) AS
BEGIN
  IF p_salary > 20000 THEN
    RAISE_APPLICATION_ERROR(-20003, 'Wynagrodzenie przekracza 20000!');
  END IF;

  INSERT INTO employees (
    employee_id, last_name, first_name, salary, job_id, department_id, hire_date, email
  ) VALUES (
    emp_seq.NEXTVAL, p_last_name, p_first_name, p_salary, p_job_id, p_dept_id, SYSDATE,
    LOWER(p_first_name || '.' || p_last_name || '@example.com')
  );

  DBMS_OUTPUT.PUT_LINE('Dodano pracownika: ' || p_first_name || ' ' || p_last_name);

END;
/
-- TEST
-- EXEC add_employee('TEST', 'JAN', 15000);


CREATE OR REPLACE PROCEDURE avg_salary_under_manager (
  p_manager_id IN  employees.manager_id%TYPE,
  p_avg_sal    OUT NUMBER
) AS
BEGIN
  SELECT AVG(salary)
  INTO   p_avg_sal
  FROM   employees
  WHERE  manager_id = p_manager_id;

EXCEPTION
  WHEN NO_DATA_FOUND THEN
    p_avg_sal := NULL;
  WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('Błąd: ' || SQLERRM);
END;
/
-- TEST
-- DECLARE s NUMBER;
-- BEGIN avg_salary_under_manager(100, s); DBMS_OUTPUT.PUT_LINE(s); END;
/

CREATE OR REPLACE PROCEDURE raise_dept_salary (
  p_dept_id IN employees.department_id%TYPE,
  p_percent IN NUMBER
) AS
BEGIN
  UPDATE employees e
  SET    e.salary = e.salary * (1 + p_percent/100)
  WHERE  e.department_id = p_dept_id
  AND EXISTS (
        SELECT 1 FROM jobs j
        WHERE j.job_id = e.job_id
          AND e.salary * (1 + p_percent/100) BETWEEN j.min_salary AND j.max_salary
      );

  IF SQL%ROWCOUNT = 0 THEN
    DBMS_OUTPUT.PUT_LINE('Brak aktualizacji — sprawdź widełki lub dept_id');
  ELSE
    DBMS_OUTPUT.PUT_LINE('Zaktualizowano: ' || SQL%ROWCOUNT || ' pracowników');
  END IF;

EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE = -2291 THEN
      DBMS_OUTPUT.PUT_LINE('BŁĄD: Nieistniejący department_id (FK)');
    ELSE
      DBMS_OUTPUT.PUT_LINE('Inny błąd: ' || SQLERRM);
    END IF;
END;
/
-- TEST
-- EXEC raise_dept_salary(10, 5);


CREATE OR REPLACE PROCEDURE move_employee (
  p_emp_id      IN employees.employee_id%TYPE,
  p_new_dept_id IN employees.department_id%TYPE
) AS
  v_count NUMBER;
  v_emp   NUMBER;
BEGIN
  SELECT COUNT(*) INTO v_emp FROM employees WHERE employee_id = p_emp_id;
  IF v_emp = 0 THEN
    RAISE_APPLICATION_ERROR(-20004, 'Pracownik nie istnieje!');
  END IF;

  SELECT COUNT(*) INTO v_count FROM departments WHERE department_id = p_new_dept_id;
  IF v_count = 0 THEN
    RAISE_APPLICATION_ERROR(-20005, 'Docelowy departament nie istnieje!');
  END IF;

  UPDATE employees
  SET    department_id = p_new_dept_id
  WHERE  employee_id = p_emp_id;

  DBMS_OUTPUT.PUT_LINE('Przeniesiono pracownika ' || p_emp_id ||
                       ' do dep. ' || p_new_dept_id);

END;
/
-- TEST
-- EXEC move_employee(100, 20);


CREATE OR REPLACE PROCEDURE delete_department (
  p_dept_id IN departments.department_id%TYPE
) AS
  v_cnt NUMBER;
BEGIN
  SELECT COUNT(*) INTO v_cnt
  FROM   employees
  WHERE  department_id = p_dept_id;

  IF v_cnt > 0 THEN
    RAISE_APPLICATION_ERROR(-20006, 'Nie można usunąć — są przypisani pracownicy!');
  END IF;

  DELETE FROM departments WHERE department_id = p_dept_id;

  DBMS_OUTPUT.PUT_LINE('Usunięto departament: ' || p_dept_id);

EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('Błąd usuwania: ' || SQLERRM);
END;
/
-- TEST
-- EXEC delete_department(280);
