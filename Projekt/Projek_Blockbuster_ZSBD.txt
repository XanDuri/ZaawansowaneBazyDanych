--*Projek_Blockbuster_ZSBD*

-- TWORZENIE TABLIC

CREATE TABLE project_branches (
    branch_id     NUMBER PRIMARY KEY,
    name          VARCHAR2(100) NOT NULL,
    city          VARCHAR2(100) NOT NULL,
    address       VARCHAR2(200) NOT NULL,
    phone         VARCHAR2(30)
);

CREATE TABLE project_customers (
    customer_id    NUMBER PRIMARY KEY,
    first_name     VARCHAR2(50) NOT NULL,
    last_name      VARCHAR2(50) NOT NULL,
    email          VARCHAR2(150) UNIQUE,
    phone          VARCHAR2(30),
    date_of_birth  DATE,
    signup_date    DATE DEFAULT SYSDATE,
    status         VARCHAR2(20) CHECK (status IN ('ACTIVE','BLOCKED'))
);

CREATE TABLE project_employees (
    employee_id  NUMBER PRIMARY KEY,
    first_name   VARCHAR2(50) NOT NULL,
    last_name    VARCHAR2(50) NOT NULL,
    email        VARCHAR2(150) UNIQUE,
    hire_date    DATE NOT NULL,
    branch_id    NUMBER REFERENCES project_branches(branch_id)
);

CREATE TABLE project_movies (
    movie_id      NUMBER PRIMARY KEY,
    title         VARCHAR2(150) NOT NULL,
    release_year  NUMBER,
    age_rating    VARCHAR2(10),
    runtime_min   NUMBER,
    imdb_id       VARCHAR2(20),
    description   VARCHAR2(500)
);

CREATE TABLE project_genres (
    genre_id    NUMBER PRIMARY KEY,
    name        VARCHAR2(50) NOT NULL
);

CREATE TABLE project_movie_genres (
    movie_id   NUMBER REFERENCES project_movies(movie_id),
    genre_id   NUMBER REFERENCES project_genres(genre_id),
    CONSTRAINT project_movie_genres_pk PRIMARY KEY (movie_id, genre_id)
);

CREATE TABLE project_inventory (
    inventory_id  NUMBER PRIMARY KEY,
    movie_id      NUMBER REFERENCES project_movies(movie_id),
    branch_id     NUMBER REFERENCES project_branches(branch_id),
    barcode       VARCHAR2(50) UNIQUE NOT NULL,
    status        VARCHAR2(20) CHECK (status IN ('AVAILABLE','RENTED'))
);

CREATE TABLE project_rentals (
    rental_id      NUMBER PRIMARY KEY,
    inventory_id   NUMBER REFERENCES project_inventory(inventory_id),
    customer_id    NUMBER REFERENCES project_customers(customer_id),
    employee_id    NUMBER REFERENCES project_employees(employee_id),
    branch_id      NUMBER REFERENCES project_branches(branch_id),

    rental_date    DATE NOT NULL,
    due_date       DATE NOT NULL,
    return_date    DATE,

    base_fee       NUMBER(6,2),
    late_fee       NUMBER(6,2),
    status         VARCHAR2(20) CHECK (status IN ('OPEN','CLOSED'))
);

CREATE TABLE project_payments (
    payment_id    NUMBER PRIMARY KEY,
    rental_id     NUMBER REFERENCES project_rentals(rental_id),
    payment_date  DATE NOT NULL,
    amount        NUMBER(8,2),
    method        VARCHAR2(20) CHECK (method IN ('CASH','CARD','ONLINE'))
);


-- DODAWANNIE PRZYKŁADOWYCH DANYCH

INSERT INTO project_branches VALUES (1, 'Blockbusters Downtown', 'Warsaw', 'ul. Marszałkowska 10', '+48 22 111 11 11');
INSERT INTO project_branches VALUES (2, 'Blockbusters Mokotów', 'Warsaw', 'ul. Puławska 200', '+48 22 222 22 22');
INSERT INTO project_branches VALUES (3, 'Blockbusters Kraków', 'Kraków', 'ul. Długa 5', '+48 12 333 33 33');

INSERT INTO project_customers VALUES (1, 'Adam','Kowalski','adam.kowalski@example.com','+48 600 100 100',DATE'1990-05-10',DATE'2024-01-01','ACTIVE');
INSERT INTO project_customers VALUES (2, 'Beata','Nowak','beata.nowak@example.com','+48 600 100 101',DATE'1988-11-23',DATE'2024-01-05','ACTIVE');
INSERT INTO project_customers VALUES (3, 'Celina','Wiśniewska','celina.w@example.com','+48 600 100 102',DATE'1995-03-02',DATE'2024-02-10','ACTIVE');
INSERT INTO project_customers VALUES (4, 'Daniel','Zieliński','daniel.z@example.com','+48 600 100 103',DATE'1982-07-19',DATE'2024-02-15','BLOCKED');
INSERT INTO project_customers VALUES (5, 'Ewa','Krawczyk','ewa.k@example.com','+48 600 100 104',DATE'1999-09-09',DATE'2024-03-01','ACTIVE');

INSERT INTO project_employees VALUES (1,'Michał','Lis','michal.lis@blockbusters.pl',DATE'2023-01-10',1);
INSERT INTO project_employees VALUES (2,'Anna','Fox','anna.fox@blockbusters.pl',DATE'2023-02-01',1);
INSERT INTO project_employees VALUES (3,'Piotr','Wolf','piotr.wolf@blockbusters.pl',DATE'2023-03-15',2);
INSERT INTO project_employees VALUES (4,'Karolina','Bury','karolina.bury@blockbusters.pl',DATE'2023-03-20',2);
INSERT INTO project_employees VALUES (5,'Tomasz','Sowa','tomasz.sowa@blockbusters.pl',DATE'2023-04-01',3);

-- TABLICE POMOCNICZE

CREATE TABLE project_action_log (
  log_id        NUMBER GENERATED BY DEFAULT AS IDENTITY
                CONSTRAINT project_action_log_pk PRIMARY KEY,
  log_date      DATE DEFAULT SYSDATE,
  user_name     VARCHAR2(50),
  operation     VARCHAR2(30),
  object_name   VARCHAR2(50),
  key_value     VARCHAR2(100),
  message       VARCHAR2(4000),
  error_code    NUMBER
);

CREATE TABLE project_import_errors (
  error_id      NUMBER GENERATED BY DEFAULT AS IDENTITY
                CONSTRAINT project_import_errors_pk PRIMARY KEY,
  source_file   VARCHAR2(200),
  row_number    NUMBER,
  raw_data      CLOB,
  error_message VARCHAR2(4000),
  created_at    DATE DEFAULT SYSDATE
);

CREATE TABLE project_customers_archive AS
SELECT c.*, SYSDATE AS archived_at
FROM   project_customers c
WHERE  1=0;

CREATE TABLE project_rentals_archive AS
SELECT r.*, SYSDATE AS archived_at
FROM   project_rentals r
WHERE  1=0;

CREATE TABLE project_monthly_stats (
  year_num        NUMBER(4),
  month_num       NUMBER(2),
  branch_id       NUMBER,
  total_rentals   NUMBER,
  total_revenue   NUMBER(12,2),
  running_revenue NUMBER(12,2),
  CONSTRAINT project_monthly_stats_pk
    PRIMARY KEY (year_num, month_num, branch_id)
);


-- PAKIET DO LOGOWANIA

CREATE OR REPLACE PACKAGE project_log_pkg AS
  PROCEDURE log_event(
    p_operation   IN VARCHAR2,
    p_object_name IN VARCHAR2,
    p_key_value   IN VARCHAR2,
    p_message     IN VARCHAR2 DEFAULT NULL,
    p_error_code  IN NUMBER   DEFAULT NULL
  );
END project_log_pkg;
/
CREATE OR REPLACE PACKAGE BODY project_log_pkg AS
  PROCEDURE log_event(
    p_operation   IN VARCHAR2,
    p_object_name IN VARCHAR2,
    p_key_value   IN VARCHAR2,
    p_message     IN VARCHAR2,
    p_error_code  IN NUMBER
  ) IS
  BEGIN
    INSERT INTO project_action_log(
      user_name, operation, object_name, key_value,
      message, error_code
    )
    VALUES (
      USER, p_operation, p_object_name, p_key_value,
      p_message, p_error_code
    );
  END log_event;
END project_log_pkg;
/


-- PAKIET GŁÓWNY
CREATE OR REPLACE PACKAGE project_rental_pkg AS

  -- Własne wyjątki
  e_customer_blocked      EXCEPTION;
  e_inventory_unavailable EXCEPTION;
  e_rental_not_found      EXCEPTION;

  PROCEDURE add_customer(
    p_customer_id   IN project_customers.customer_id%TYPE,
    p_first_name    IN project_customers.first_name%TYPE,
    p_last_name     IN project_customers.last_name%TYPE,
    p_email         IN project_customers.email%TYPE,
    p_phone         IN project_customers.phone%TYPE,
    p_date_of_birth IN project_customers.date_of_birth%TYPE
  );

  PROCEDURE rent_movie(
    p_rental_id    IN project_rentals.rental_id%TYPE,
    p_inventory_id IN project_rentals.inventory_id%TYPE,
    p_customer_id  IN project_rentals.customer_id%TYPE,
    p_employee_id  IN project_rentals.employee_id%TYPE,
    p_branch_id    IN project_rentals.branch_id%TYPE,
    p_days         IN NUMBER DEFAULT 3,
    p_base_fee     IN NUMBER DEFAULT 10
  );

  PROCEDURE return_movie(
    p_rental_id    IN project_rentals.rental_id%TYPE,
    p_employee_id  IN project_rentals.employee_id%TYPE,
    p_daily_late_fee IN NUMBER DEFAULT 2
  );

  PROCEDURE delete_customer(
    p_customer_id IN project_customers.customer_id%TYPE
  );

  FUNCTION is_customer_adult(
    p_customer_id IN project_customers.customer_id%TYPE
  ) RETURN BOOLEAN;

END project_rental_pkg;
/


-- BODY
CREATE OR REPLACE PACKAGE BODY project_rental_pkg AS

  FUNCTION is_customer_adult(
    p_customer_id IN project_customers.customer_id%TYPE
  ) RETURN BOOLEAN IS
    v_dob  project_customers.date_of_birth%TYPE;
    v_years NUMBER;
  BEGIN
    SELECT date_of_birth
    INTO   v_dob
    FROM   project_customers
    WHERE  customer_id = p_customer_id;

    IF v_dob IS NULL THEN
      RETURN FALSE;
    END IF;

    v_years := FLOOR(MONTHS_BETWEEN(SYSDATE, v_dob)/12);

    RETURN v_years >= 18;
  EXCEPTION
    WHEN NO_DATA_FOUND THEN
      RETURN FALSE;
  END is_customer_adult;

  PROCEDURE add_customer(
    p_customer_id   IN project_customers.customer_id%TYPE,
    p_first_name    IN project_customers.first_name%TYPE,
    p_last_name     IN project_customers.last_name%TYPE,
    p_email         IN project_customers.email%TYPE,
    p_phone         IN project_customers.phone%TYPE,
    p_date_of_birth IN project_customers.date_of_birth%TYPE
  ) IS
  BEGIN
    INSERT INTO project_customers(
      customer_id, first_name, last_name,
      email, phone, date_of_birth,
      signup_date, status
    ) VALUES (
      p_customer_id, p_first_name, p_last_name,
      p_email, p_phone, p_date_of_birth,
      SYSDATE, 'ACTIVE'
    );

    project_log_pkg.log_event(
      p_operation   => 'INSERT',
      p_object_name => 'PROJECT_CUSTOMERS',
      p_key_value   => TO_CHAR(p_customer_id),
      p_message     => 'Dodano klienta '||p_first_name||' '||p_last_name
    );
  EXCEPTION
    WHEN DUP_VAL_ON_INDEX THEN
      project_log_pkg.log_event(
        'ERROR','PROJECT_CUSTOMERS',TO_CHAR(p_customer_id),
        'Duplikat klucza lub e-mail', SQLCODE
      );
      RAISE;
    WHEN OTHERS THEN
      project_log_pkg.log_event(
        'ERROR','PROJECT_CUSTOMERS',TO_CHAR(p_customer_id),
        SQLERRM, SQLCODE
      );
      RAISE;
  END add_customer;

  PROCEDURE rent_movie(
    p_rental_id    IN project_rentals.rental_id%TYPE,
    p_inventory_id IN project_rentals.inventory_id%TYPE,
    p_customer_id  IN project_rentals.customer_id%TYPE,
    p_employee_id  IN project_rentals.employee_id%TYPE,
    p_branch_id    IN project_rentals.branch_id%TYPE,
    p_days         IN NUMBER,
    p_base_fee     IN NUMBER
  ) IS
    v_status    project_customers.status%TYPE;
    v_inv_status project_inventory.status%TYPE;
    v_adult     BOOLEAN;
  BEGIN
    SELECT status
    INTO   v_status
    FROM   project_customers
    WHERE  customer_id = p_customer_id;

    IF v_status = 'BLOCKED' THEN
      RAISE e_customer_blocked;
    END IF;

    v_adult := is_customer_adult(p_customer_id);

    SELECT status
    INTO   v_inv_status
    FROM   project_inventory
    WHERE  inventory_id = p_inventory_id;

    IF v_inv_status <> 'AVAILABLE' THEN
      RAISE e_inventory_unavailable;
    END IF;

    INSERT INTO project_rentals(
      rental_id, inventory_id, customer_id,
      employee_id, branch_id,
      rental_date, due_date,
      base_fee, late_fee, status
    ) VALUES (
      p_rental_id, p_inventory_id, p_customer_id,
      p_employee_id, p_branch_id,
      SYSDATE, SYSDATE + p_days,
      p_base_fee, 0, 'OPEN'
    );

    UPDATE project_inventory
    SET    status = 'RENTED'
    WHERE  inventory_id = p_inventory_id;

    project_log_pkg.log_event(
      'INSERT','PROJECT_RENTALS',TO_CHAR(p_rental_id),
      'Nowe wypożyczenie, klient='||p_customer_id
    );
  EXCEPTION
    WHEN e_customer_blocked THEN
      project_log_pkg.log_event(
        'ERROR','PROJECT_RENTALS',TO_CHAR(p_rental_id),
        'Klient zablokowany: '||p_customer_id, -20001
      );
      RAISE_APPLICATION_ERROR(-20001,'Klient jest zablokowany.');
    WHEN e_inventory_unavailable THEN
      project_log_pkg.log_event(
        'ERROR','PROJECT_RENTALS',TO_CHAR(p_rental_id),
        'Egzemplarz niedostępny: '||p_inventory_id, -20002
      );
      RAISE_APPLICATION_ERROR(-20002,'Egzemplarz nie jest dostępny.');
    WHEN NO_DATA_FOUND THEN
      project_log_pkg.log_event(
        'ERROR','PROJECT_RENTALS',TO_CHAR(p_rental_id),
        'Brak klienta lub egzemplarza', SQLCODE
      );
      RAISE;
    WHEN OTHERS THEN
      project_log_pkg.log_event(
        'ERROR','PROJECT_RENTALS',TO_CHAR(p_rental_id),
        SQLERRM, SQLCODE
      );
      RAISE;
  END rent_movie;

  PROCEDURE return_movie(
    p_rental_id    IN project_rentals.rental_id%TYPE,
    p_employee_id  IN project_rentals.employee_id%TYPE,
    p_daily_late_fee IN NUMBER
  ) IS
    v_inventory_id project_rentals.inventory_id%TYPE;
    v_due_date     project_rentals.due_date%TYPE;
    v_return_date  DATE := SYSDATE;
    v_days_late    NUMBER;
    v_late_fee     NUMBER;
  BEGIN
    SELECT inventory_id, due_date
    INTO   v_inventory_id, v_due_date
    FROM   project_rentals
    WHERE  rental_id = p_rental_id
    FOR UPDATE;

    v_days_late := GREATEST(TRUNC(v_return_date) - TRUNC(v_due_date), 0);
    v_late_fee  := v_days_late * p_daily_late_fee;

    UPDATE project_rentals
    SET    return_date = v_return_date,
           late_fee    = v_late_fee,
           status      = 'CLOSED'
    WHERE  rental_id   = p_rental_id;

    UPDATE project_inventory
    SET    status = 'AVAILABLE'
    WHERE  inventory_id = v_inventory_id;

    project_log_pkg.log_event(
      'UPDATE','PROJECT_RENTALS',TO_CHAR(p_rental_id),
      'Zwrot, kara='||TO_CHAR(v_late_fee)
    );
  EXCEPTION
    WHEN NO_DATA_FOUND THEN
      project_log_pkg.log_event(
        'ERROR','PROJECT_RENTALS',TO_CHAR(p_rental_id),
        'Nie znaleziono wypożyczenia', -20003
      );
      RAISE_APPLICATION_ERROR(-20003,'Nie znaleziono wypożyczenia.');
    WHEN OTHERS THEN
      project_log_pkg.log_event(
        'ERROR','PROJECT_RENTALS',TO_CHAR(p_rental_id),
        SQLERRM, SQLCODE
      );
      RAISE;
  END return_movie;

  -- Usunięcie klienta (archiwizacja w triggerze)
  PROCEDURE delete_customer(
    p_customer_id IN project_customers.customer_id%TYPE
  ) IS
  BEGIN
    DELETE FROM project_customers
    WHERE customer_id = p_customer_id;

    IF SQL%ROWCOUNT = 0 THEN
      RAISE_APPLICATION_ERROR(-20004,'Klient nie istnieje.');
    END IF;

    project_log_pkg.log_event(
      'DELETE','PROJECT_CUSTOMERS',TO_CHAR(p_customer_id),
      'Usunięto klienta (zarchiwizowano triggerem)'
    );
  EXCEPTION
    WHEN OTHERS THEN
      project_log_pkg.log_event(
        'ERROR','PROJECT_CUSTOMERS',TO_CHAR(p_customer_id),
        SQLERRM, SQLCODE
      );
      RAISE;
  END delete_customer;

END project_rental_pkg;
/


-- WYZWALACZE

CREATE OR REPLACE TRIGGER project_trg_customers_archive
BEFORE DELETE ON project_customers
FOR EACH ROW
BEGIN
  INSERT INTO project_customers_archive (
      customer_id,
      first_name,
      last_name,
      email,
      phone,
      date_of_birth,
      signup_date,
      status,
      archived_at
  )
  VALUES (
      :OLD.customer_id,
      :OLD.first_name,
      :OLD.last_name,
      :OLD.email,
      :OLD.phone,
      :OLD.date_of_birth,
      :OLD.signup_date,
      :OLD.status,
      SYSDATE
  );
END;
/

CREATE OR REPLACE TRIGGER project_trg_rentals_archive
BEFORE DELETE ON project_rentals
FOR EACH ROW
BEGIN
  INSERT INTO project_rentals_archive (
      rental_id,
      inventory_id,
      customer_id,
      employee_id,
      branch_id,
      rental_date,
      due_date,
      return_date,
      base_fee,
      late_fee,
      status,
      archived_at
  )
  VALUES (
      :OLD.rental_id,
      :OLD.inventory_id,
      :OLD.customer_id,
      :OLD.employee_id,
      :OLD.branch_id,
      :OLD.rental_date,
      :OLD.due_date,
      :OLD.return_date,
      :OLD.base_fee,
      :OLD.late_fee,
      :OLD.status,
      SYSDATE
  );
END;
/

CREATE OR REPLACE TRIGGER project_trg_rentals_log
AFTER INSERT OR UPDATE OR DELETE ON project_rentals
FOR EACH ROW
DECLARE
  v_op VARCHAR2(10);
  v_id VARCHAR2(100);
BEGIN
  IF INSERTING THEN
    v_op := 'INSERT';
    v_id := TO_CHAR(:NEW.rental_id);
  ELSIF UPDATING THEN
    v_op := 'UPDATE';
    v_id := TO_CHAR(:NEW.rental_id);
  ELSIF DELETING THEN
    v_op := 'DELETE';
    v_id := TO_CHAR(:OLD.rental_id);
  END IF;

  project_log_pkg.log_event(
    p_operation   => v_op,
    p_object_name => 'PROJECT_RENTALS',
    p_key_value   => v_id,
    p_message     => 'Trigger log'
  );
END;
/

-- FUNKCJE OKIENKOWE
CREATE OR REPLACE PACKAGE project_stats_pkg AS

  -- generuje statystyki miesięczne dla podanego roku
  PROCEDURE generate_monthly_stats(
    p_year IN NUMBER DEFAULT NULL
  );

  -- zwraca ranking filmów w danym roku i miesiącu (ref cursor)
  FUNCTION top_movies_for_month(
    p_year  IN NUMBER,
    p_month IN NUMBER
  ) RETURN SYS_REFCURSOR;

END project_stats_pkg;
/

-- BODY
CREATE OR REPLACE PACKAGE BODY project_stats_pkg AS

  PROCEDURE generate_monthly_stats(
    p_year IN NUMBER
  ) IS
  BEGIN
    IF p_year IS NOT NULL THEN
      DELETE FROM project_monthly_stats WHERE year_num = p_year;
    ELSE
      DELETE FROM project_monthly_stats;
    END IF;

    INSERT INTO project_monthly_stats(
      year_num, month_num, branch_id,
      total_rentals, total_revenue, running_revenue
    )
    SELECT
      year_num,
      month_num,
      branch_id,
      total_rentals,
      total_revenue,
      SUM(total_revenue) OVER (
        PARTITION BY branch_id, year_num
        ORDER BY month_num
      ) AS running_revenue
    FROM (
      SELECT
        EXTRACT(YEAR  FROM p.payment_date) AS year_num,
        EXTRACT(MONTH FROM p.payment_date) AS month_num,
        r.branch_id,
        COUNT(DISTINCT r.rental_id) AS total_rentals,
        SUM(p.amount) AS total_revenue
      FROM   project_payments p
      JOIN   project_rentals  r ON r.rental_id = p.rental_id
      GROUP  BY EXTRACT(YEAR  FROM p.payment_date),
               EXTRACT(MONTH FROM p.payment_date),
               r.branch_id
    ) t
    WHERE p_year IS NULL OR year_num = p_year;

    project_log_pkg.log_event(
      'STATS','PROJECT_MONTHLY_STATS',
      NVL(TO_CHAR(p_year),'ALL'),
      'Przeliczono statystyki miesięczne'
    );
  END generate_monthly_stats;


  FUNCTION top_movies_for_month(
    p_year  IN NUMBER,
    p_month IN NUMBER
  ) RETURN SYS_REFCURSOR IS
    v_cur SYS_REFCURSOR;
  BEGIN
    OPEN v_cur FOR
      SELECT
        m.movie_id,
        m.title,
        COUNT(*) AS rental_count,
        RANK() OVER (ORDER BY COUNT(*) DESC) AS rank_global
      FROM   project_rentals r
      JOIN   project_inventory i ON i.inventory_id = r.inventory_id
      JOIN   project_movies    m ON m.movie_id     = i.movie_id
      WHERE  EXTRACT(YEAR  FROM r.rental_date) = p_year
      AND    EXTRACT(MONTH FROM r.rental_date) = p_month
      GROUP  BY m.movie_id, m.title;

    RETURN v_cur;
  END top_movies_for_month;

END project_stats_pkg;
/

-- TESTY
-- TEST 1 - Dodanie klientów (pakiet)
BEGIN
  project_rental_pkg.add_customer(
    p_customer_id   => 100,
    p_first_name    => 'Jan',
    p_last_name     => 'Testowy',
    p_email         => 'jan.test@example.com',
    p_phone         => '+48 700 800 900',
    p_date_of_birth => DATE'1990-01-01'
  );
END;
/

-- TEST 2 - Próba dodania duplikatu klienta (log błędu)
BEGIN
  project_rental_pkg.add_customer(
    100, 'Duplikat', 'Error', 'jan.test@example.com', NULL, DATE'1990-01-01'
  );
END;
/

-- TEST 3 - Test wypożyczenia filmu
INSERT INTO project_movies VALUES (1,'Matrix',1999,'16+',130,'tt0133093','Sci-fi classic');
INSERT INTO project_genres VALUES (1,'Sci-Fi');
INSERT INTO project_movie_genres VALUES (1,1);

INSERT INTO project_inventory VALUES (1,1,1,'BC001','AVAILABLE');
BEGIN
  project_rental_pkg.rent_movie(
    p_rental_id    => 500,
    p_inventory_id => 1,
    p_customer_id  => 1,
    p_employee_id  => 1,
    p_branch_id    => 1,
    p_days         => 3,
    p_base_fee     => 12
  );
END;
/

-- TEST 4 - Próba wypożyczenia niedostępnego egzemplarza
BEGIN
  project_rental_pkg.rent_movie(
    501, 1, 1, 1, 1, 3, 12
  );
END;
/

-- TEST 5 - Zwrot filmu
BEGIN
  project_rental_pkg.return_movie(
    p_rental_id => 500,
    p_employee_id => 1,
    p_daily_late_fee => 2
  );
END;
/

-- TEST 6 - Usunięcie klienta (archiwizacja w triggerze)
BEGIN
  project_rental_pkg.delete_customer(100);
END;
/

SELECT * FROM project_customers_archive;


-- TEST 7 - Wyzwalacze logujące
SELECT * FROM project_action_log ORDER BY log_id DESC;


-- TEST 8 - Statystyki miesięczne
INSERT INTO project_payments VALUES (1, 500, SYSDATE, 15, 'CARD');
BEGIN
  project_stats_pkg.generate_monthly_stats;
END;
/

SELECT * FROM project_monthly_stats;


-- TEST 9 - Ranking filmów w danym miesiącu
VAR rc REFCURSOR

BEGIN
  :rc := project_stats_pkg.top_movies_for_month(
    EXTRACT(YEAR FROM SYSDATE),
    EXTRACT(MONTH FROM SYSDATE)
  );
END;
/

PRINT rc;
